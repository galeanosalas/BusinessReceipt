<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Batch Receipt Upload</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 700px; margin: 40px auto; }
    label { display: block; margin-top: 20px; font-weight: bold; }
    select, input, textarea { width: 100%; padding: 8px; margin-top: 5px; }
    button { margin-top: 20px; padding: 10px 20px; font-size: 16px; }
    .file-card {
      border: 1px solid #ccc;
      padding: 15px;
      margin-top: 20px;
      border-radius: 8px;
    }
    .file-title {
      font-weight: bold;
      margin-bottom: 10px;
    }
    #status { margin-top: 20px; font-weight: bold; }
  </style>
</head>
<body>

<h2>Batch Receipt Upload</h2>

<label>Select Files (PDFs or Images)</label>
<input type="file" id="fileInput" accept=".pdf,image/*" multiple>

<label>Category (applies to all)</label>
<select id="category"></select>

<label>Gig (applies to all)</label>
<select id="gig"></select>

<button onclick="generateCards()">Prepare Uploads</button>

<div id="fileCards"></div>

<button id="uploadAllBtn" style="display:none;" onclick="uploadAll()">Upload All</button>

<div id="status"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxIhxkK2c603t_lKc03CaVos0B-XQTQTFGHjqT4-1lCJIlLAqmH16zTpQc2Z44YnJTC0w/exec";

async function loadLists() {
  const res = await fetch(API_URL + "?action=getLists");
  const data = await res.json();

  const catSelect = document.getElementById("category");
  const gigSelect = document.getElementById("gig");

  data.categories.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    catSelect.appendChild(opt);
  });

  data.gigs.forEach(g => {
    const opt = document.createElement("option");
    opt.value = g;
    opt.textContent = g;
    gigSelect.appendChild(opt);
  });
}

function generateCards() {
  const files = document.getElementById("fileInput").files;
  const container = document.getElementById("fileCards");
  container.innerHTML = "";

  if (!files.length) {
    alert("Please select files first.");
    return;
  }

  Array.from(files).forEach((file, index) => {
    const card = document.createElement("div");
    card.className = "file-card";

    card.innerHTML = `
      <div class="file-title">${file.name}</div>
      <label>Description</label>
      <textarea id="desc_${index}" rows="2"></textarea>
      <button onclick="uploadSingle(${index})">Upload This File</button>
      <div id="status_${index}" style="margin-top:10px;"></div>
    `;

    container.appendChild(card);
  });

  document.getElementById("uploadAllBtn").style.display = "block";
}

async function uploadSingle(index) {
  const files = document.getElementById("fileInput").files;
  const file = files[index];
  const description = document.getElementById("desc_" + index).value;
  const category = document.getElementById("category").value;
  const gig = document.getElementById("gig").value;

  const base64 = await fileToBase64(file);

  const payload = {
    who: "Galeano",
    category,
    description,
    fileName: file.name,
    fileMimeType: file.type || "application/octet-stream",
    fileData: base64.split(",")[1],
    gig
  };

  const res = await fetch(API_URL + "?action=uploadReceipt", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const result = await res.json();
  document.getElementById("status_" + index).textContent = result.message;
}

async function uploadAll() {
  const files = document.getElementById("fileInput").files;

  for (let i = 0; i < files.length; i++) {
    await uploadSingle(i);
  }

  document.getElementById("status").textContent = "All files uploaded!";
}

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

loadLists();
</script>

</body>
</html>

